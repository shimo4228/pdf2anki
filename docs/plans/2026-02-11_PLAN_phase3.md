# Phase 3 実装計画: pdf2anki プロダクト成熟 (2026-02 ~ 2026-04)

**作成日:** 2026-02-11
**ステータス:** Draft
**推定工数:** 16 時間
**スコープ:** pdf2anki リポジトリ内に閉じたタスクのみ

---

## スコープポリシー

> **このプランは pdf2anki プロジェクトフォルダ内で完結するタスクだけを扱う。**
>
> 以下は意図的にスコープ外とする:
> - Zenn 記事・Book 執筆 → zenn-content リポジトリ
> - マルチプラットフォーム投稿 CLI → zenn-content リポジトリ
> - LinkedIn/note 投稿 → 個人ブランディング（プロジェクト外）
> - YouTube/Podcast → コンテンツ制作（プロジェクト外）
>
> 他プロジェクトのタスクは各リポジトリの PLAN ファイルで管理する。
> ロードマップ全体像は `~/MyAI_Lab/docs/architecture/07-roadmap.md` を参照。

---

## Context

Phase 2 (v0.3.0) 完了:
- 624 テスト、92.26% カバレッジ、ruff+mypy clean
- 実装済み: Vision, TUI, Cache, Eval, Batch, Section-aware, Cross-section dedup
- 依存 8 個: anthropic, pymupdf, pymupdf4llm, pydantic, pyyaml, typer, rich, textual

Phase 3 では pdf2anki の**プロダクトとしての完成度**を上げる。

---

## 実装順序

```
[1] AnkiConnect API 統合 (6h)     ← Anki への直接カード追加
[2] Japanese Token Estimation (2h) ← コスト見積もり精度向上
[3] Web UI PoC (8h)               ← 非開発者向け GUI（オプション）
```

**理由:**
- AnkiConnect は既存ユーザーの最大の摩擦ポイント（TSV → 手動インポート）を解消
- Token Estimation は既知の技術的負債で、コスト見積もりの信頼性に直結
- Web UI は P3 のオプション。PoC 段階で判断する

---

## Task 1: AnkiConnect API 統合 (P1, 6h) ✅ 完了 2026-02-11

### 目的

`pdf2anki convert input.pdf --push` でカードを直接 Anki に追加する。
TSV → Anki インポートの手動ステップを廃止し、ワンコマンド完結を実現。

### 前提条件

- Anki デスクトップアプリが起動中であること
- [AnkiConnect](https://foosoft.net/projects/anki-connect/) アドオンがインストール済みであること
  - アドオン番号: 2055492159
  - ローカル HTTP API: `http://localhost:8765`

### アーキテクチャ

```
生成カード (AnkiCard リスト)
    ↓
[AnkiConnect Client] HTTP POST to localhost:8765
    ↓
接続チェック (version アクション)
    ↓ (成功)                    ↓ (失敗)
デッキ存在確認/作成          エラー: "Anki が起動していません"
    ↓
ノートタイプ確認/作成
    ↓
バッチ addNotes
    ↓
結果レポート (追加数/失敗数)
```

### ファイル構成

| ファイル | 操作 | LOC目安 | 内容 |
|---------|------|---------|------|
| `src/pdf2anki/anki_connect.py` | **新規** | ~200 | AnkiConnect HTTP クライアント |
| `src/pdf2anki/main.py` | 修正 | +15 | `--push`, `--deck` オプション追加 |
| `src/pdf2anki/service.py` | 修正 | +20 | push_to_anki() ワークフロー統合 |
| `tests/test_anki_connect.py` | **新規** | ~200 | モックベースのテスト |

### anki_connect.py 設計

```python
# src/pdf2anki/anki_connect.py (~200 LOC)
from dataclasses import dataclass

ANKICONNECT_URL = "http://localhost:8765"
ANKICONNECT_VERSION = 6

@dataclass(frozen=True)
class PushResult:
    """Anki への push 結果。"""
    total: int
    added: int
    failed: int
    errors: tuple[str, ...]

def is_anki_running(url: str = ANKICONNECT_URL) -> bool:
    """AnkiConnect が応答するか確認。"""

def ensure_deck(deck_name: str, *, url: str = ANKICONNECT_URL) -> None:
    """デッキが存在しなければ作成。"""

def push_cards(
    cards: list[AnkiCard],
    *,
    deck_name: str = "pdf2anki",
    url: str = ANKICONNECT_URL,
) -> PushResult:
    """カードを AnkiConnect 経由で追加。

    - Basic/QA → Basic ノートタイプ (Front/Back)
    - Cloze → Cloze ノートタイプ (Text/Extra)
    - タグはそのまま Anki タグに変換
    """

def _invoke(action: str, **params: Any) -> Any:
    """AnkiConnect API を呼び出すヘルパー。"""
```

### AnkiConnect API 仕様メモ

```json
// 接続確認
{"action": "version", "version": 6}
// → 6

// デッキ作成
{"action": "createDeck", "version": 6, "params": {"deck": "pdf2anki::Chapter1"}}

// ノート追加 (バッチ)
{"action": "addNotes", "version": 6, "params": {
    "notes": [{
        "deckName": "pdf2anki",
        "modelName": "Basic",
        "fields": {"Front": "...", "Back": "..."},
        "tags": ["pdf2anki", "chapter1"]
    }]
}}
```

### CLI オプション

```bash
# Anki に直接 push
pdf2anki convert input.pdf --push

# デッキ名を指定
pdf2anki convert input.pdf --push --deck "pdf2anki::物理学"

# レビュー後に push (TUI → Accept したカードのみ)
pdf2anki convert input.pdf --review --push
```

### 実装サブステップ

| # | タスク | 工数 | TDD |
|---|--------|------|-----|
| 1.1 | `anki_connect.py` + `test_anki_connect.py` (HTTP クライアント) | 2.5h | RED→GREEN |
| 1.2 | カードタイプ変換ロジック (AnkiCard → AnkiConnect Note) | 1h | RED→GREEN |
| 1.3 | `main.py` + `service.py` 統合 (`--push`, `--deck`) | 1h | テスト更新 |
| 1.4 | エラーハンドリング + 手動 E2E テスト | 1h | GREEN確認 |
| 1.5 | README 更新 (AnkiConnect セットアップ手順) | 0.5h | - |

### 検証方法

```bash
# 1. ユニットテスト (モック)
uv run pytest tests/test_anki_connect.py -v

# 2. E2E テスト (Anki 起動状態で)
uv run pdf2anki convert tests/fixtures/sample.txt --push --deck "pdf2anki-test"
# → Anki に "pdf2anki-test" デッキが作成され、カードが追加されることを確認

# 3. TUI + Push 連携
uv run pdf2anki convert tests/fixtures/sample.txt --review --push
# → TUI で Accept したカードのみ Anki に push されることを確認
```

### 技術的注意点

1. **外部依存なし**: AnkiConnect は HTTP API なので `urllib.request` のみで実装可能（依存追加不要）
2. **画像カード**: Vision で生成した画像付きカードの push は Phase 3 ではスキップ（テキストのみ）
3. **Cloze 変換**: AnkiCard の cloze テキストを `{{c1::...}}` 形式に変換する必要あり
4. **エラー体験**: Anki 未起動時は明確なエラーメッセージ + セットアップ手順の案内

---

## Task 2: Japanese Token Estimation 修正 (P2, 2h) ✅ 完了 2026-02-11

### 目的

日本語テキストのトークン数推定を修正し、コスト見積もり精度を向上させる。

### 現状の問題

```python
# src/pdf2anki/extract.py
CHARS_PER_TOKEN = 4  # ← 英語ベースの仮定

# 日本語テキストの場合:
# "これは日本語のテストです" (13 chars)
# → 現在の推定: 13/4 = 3.25 tokens (過小)
# → 実際: 13/2.5 = 5.2 tokens
# → 誤差: 60% の過小推定
```

**影響:**
- `pdf2anki preview` のコスト見積もりが日本語で 60% ズレる
- `budget_limit` のガード精度が低下

### 設計

```python
# src/pdf2anki/extract.py に追加

CJK_CHARS_PER_TOKEN = 2.5
LATIN_CHARS_PER_TOKEN = 4.0

def estimate_tokens(text: str) -> int:
    """CJK 対応のトークン数推定。"""
    cjk_count = sum(1 for c in text if _is_cjk(c))
    other_count = len(text) - cjk_count
    return int(cjk_count / CJK_CHARS_PER_TOKEN + other_count / LATIN_CHARS_PER_TOKEN)

def _is_cjk(char: str) -> bool:
    """CJK 文字判定 (漢字、ひらがな、カタカナ)。"""
    cp = ord(char)
    return (
        0x4E00 <= cp <= 0x9FFF      # CJK Unified Ideographs
        or 0x3040 <= cp <= 0x309F   # Hiragana
        or 0x30A0 <= cp <= 0x30FF   # Katakana
        or 0x3400 <= cp <= 0x4DBF   # CJK Extension A
        or 0xF900 <= cp <= 0xFAFF   # CJK Compatibility
    )
```

### ファイル構成

| ファイル | 操作 | 内容 |
|---------|------|------|
| `src/pdf2anki/extract.py` | 修正 | `estimate_tokens()`, `_is_cjk()` 追加、既存の `CHARS_PER_TOKEN` 利用箇所を置換 |
| `src/pdf2anki/cost.py` | 修正 | トークン推定に `estimate_tokens()` を使用 |
| `tests/test_extract.py` | 修正 | トークン推定テスト追加 |

### 実装サブステップ

| # | タスク | 工数 | TDD |
|---|--------|------|-----|
| 2.1 | `estimate_tokens()` + テスト (日本語/英語/混合) | 1h | RED→GREEN |
| 2.2 | `extract.py` 内の `CHARS_PER_TOKEN` 利用箇所を置換 | 0.5h | GREEN維持 |
| 2.3 | `cost.py` のトークン推定更新 | 0.5h | GREEN維持 |

### 検証方法

```bash
# 日本語 PDF でのコスト見積もり精度確認
uv run pdf2anki preview tests/fixtures/sample_japanese.txt
# → 表示されるトークン数と実際の API 使用量を比較
```

---

## Task 3: Web UI PoC (P3, 8h) — オプション

### 目的

非開発者（CLI に不慣れなユーザー）向けに、ブラウザベースの GUI を PoC として検討する。

### 判断基準

Task 1, 2 完了後に以下を評価して着手可否を決定:
- pdf2anki の利用者像にブラウザ UI のニーズがあるか
- Streamlit / Gradio / FastAPI + HTMX のどれが最小工数か
- PoC で検証したい仮説は何か

### 暫定設計 (Streamlit)

```
ブラウザ (localhost:8501)
    ↓
[Streamlit App]
  ├── ファイルアップロード (PDF/TXT/MD)
  ├── 設定パネル (model, quality, vision, etc.)
  ├── 生成ボタン → service.py 呼び出し
  ├── カード一覧表示 + Accept/Reject
  └── エクスポート (TSV/JSON ダウンロード or Anki Push)
```

### ファイル構成

| ファイル | 操作 | LOC目安 |
|---------|------|---------|
| `src/pdf2anki/web/__init__.py` | **新規** | ~5 |
| `src/pdf2anki/web/app.py` | **新規** | ~200 |
| `pyproject.toml` | 修正 | `[project.optional-dependencies]` に streamlit 追加 |

### 留意事項

- Streamlit は optional dependency (`uv sync --extra web`)
- CLI の service.py を再利用し、UI 層のみ追加
- PoC なのでテストは手動確認のみ、自動テストは不要

---

## リスクと軽減策

| リスク | 影響度 | 軽減策 |
|--------|--------|--------|
| AnkiConnect アドオン未インストールで push 失敗 | 中 | 明確なエラーメッセージ + README にセットアップ手順 |
| Cloze カードの `{{c1::}}` 変換不具合 | 中 | Anki の Cloze フォーマット仕様を事前調査、テストケース充実 |
| `estimate_tokens()` の精度がモデル依存 | 低 | Claude のトークナイザは公開されていないため推定値で妥協 |
| Web UI の依存肥大化 | 低 | optional dependency で分離、PoC 判断後に正式採用可否を決定 |

---

## 成功指標

- [x] `pdf2anki convert input.pdf --push` で Anki にカードが追加できる
- [x] 日本語テキストのコスト見積もり誤差が 20% 以内
- [ ] テストカバレッジ 80% 以上を維持
- [ ] (オプション) Web UI PoC が localhost で動作する

---

## Phase 3 完了後の pdf2anki 状態

```
v0.4.0 (Phase 3)
├── CLI: convert, preview, eval, batch
├── 出力: TSV, JSON, AnkiConnect push  ← NEW
├── Vision: 画像検出 + Vision API
├── TUI: 対話的カードレビュー
├── Cache: SHA-256 抽出キャッシュ
├── Eval: keyword-based F1 評価
├── Cost: CJK 対応トークン推定  ← FIXED
└── (PoC) Web UI  ← OPTIONAL
```
