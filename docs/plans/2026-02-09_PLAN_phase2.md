# Phase 2 実装計画: 高価値機能 (2026-03 ~ 2026-04)

**作成日:** 2026-02-09
**ステータス:** In Progress (Task 1 完了)
**推定工数:** 25 時間
**著者:** Claude Code + shimomoto_tatsuya

---

## Context

Phase 1 (基盤固め) は実質完了:
- quality/ パッケージ化 (cc3085e)
- service.py による Service 層抽出
- 477 テスト、91% カバレッジ
- zenn-content リポジトリ + 初回記事

Phase 2 では pdf2anki の**差別化機能**を実装し、v0.3.0 リリースを目指す。

---

## 実装順序

依存関係と ROI を考慮した推奨順序:

```
[1] テキスト抽出キャッシュ (3h)    ✅ 完了 (2026-02-10)
[2] Image-Aware Card Generation (8h) ← P0、最高価値、Phase 2 の柱
[3] Prompt Evaluation Framework (4h) ← 依存なし、[2] のプロンプト改善に活用
[4] Interactive Review TUI (6h)      ← service.py 依存 (完了済み)、[2] の画像カード対応
[5] LinkedIn/GitHub 英語化 (2h)     ← コード外タスク
[6] Zenn 記事 3本 (4h)              ← [2][3][4] の実装後に執筆
```

**理由:**
- キャッシュを最初に実装すると、以降の開発・テスト時に PDF 再抽出が不要になり開発速度向上
- Image-Aware は Phase 2 の核心。早期に着手してリスクを洗い出す
- Eval Framework は Image-Aware のプロンプト品質検証に必要
- TUI は全機能を統合するレビュー UI なので最後に実装

---

## Task 1: テキスト抽出キャッシュ (P2, 3h) ✅ 完了

> **完了日:** 2026-02-10 | **実績:** cache.py (190 LOC), 518 tests, 96.74% coverage
> **設計変更:** extract_text() へのパラメータ追加ではなく、service.py に extract_with_cache() ラッパーを配置 (SRP)

### 目的

同一 PDF を繰り返し処理する際の冗長な抽出をスキップし、開発・テスト・本番すべてで高速化する。

### 設計

```
PDF ファイル
    ↓
SHA-256 ハッシュ計算 (ファイル内容)
    ↓
.cache/{hash}.json 存在チェック
    ↓ (miss)              ↓ (hit)
pymupdf4llm 抽出       JSON 読み込み
    ↓                     ↓
結果を JSON 保存       ExtractedDocument 復元
    ↓                     ↓
    └────── 共通処理 ──────┘
```

### ファイル構成

| ファイル | 操作 | 内容 |
|---------|------|------|
| `src/pdf2anki/cache.py` | **新規** | キャッシュ管理 (read/write/invalidate) |
| `src/pdf2anki/extract.py` | 修正 | `extract_text()` にキャッシュ統合 |
| `src/pdf2anki/config.py` | 修正 | `cache_enabled`, `cache_dir` 設定追加 |
| `config.yaml` | 修正 | `cache:` セクション追加 |
| `tests/test_cache.py` | **新規** | キャッシュ単体テスト |
| `tests/test_extract.py` | 修正 | キャッシュ統合テスト追加 |

### cache.py 設計

```python
# src/pdf2anki/cache.py (~120 LOC)

@dataclass(frozen=True)
class CacheEntry:
    """キャッシュされた抽出結果。"""
    file_hash: str
    source_path: str
    text: str
    chunks: tuple[str, ...]
    file_type: str
    used_ocr: bool
    created_at: str  # ISO 8601

def compute_file_hash(path: Path) -> str:
    """SHA-256 ハッシュをチャンク読みで計算 (大ファイル対応)。"""

def read_cache(cache_dir: Path, file_hash: str) -> CacheEntry | None:
    """キャッシュ読み込み。存在しない/破損時は None。"""

def write_cache(cache_dir: Path, entry: CacheEntry) -> Path:
    """キャッシュ書き込み。ディレクトリ自動作成。"""

def invalidate_cache(cache_dir: Path, file_hash: str | None = None) -> int:
    """キャッシュ削除。file_hash=None で全削除。削除数を返す。"""
```

### config.yaml 追加

```yaml
cache:
  enabled: true
  dir: ".cache"  # プロジェクトルート相対
```

### extract.py 修正ポイント

`extract_text()` の先頭でキャッシュチェック:

```python
def extract_text(
    file_path: str | Path,
    *,
    ocr_enabled: bool = False,
    ocr_lang: str = "jpn+eng",
    token_limit: int = DEFAULT_TOKEN_LIMIT,
    cache_enabled: bool = False,      # 新規パラメータ
    cache_dir: Path | None = None,    # 新規パラメータ
) -> ExtractedDocument:
    # キャッシュヒット時は即座に返す
    # キャッシュミス時は通常抽出 → キャッシュ保存
```

### CLI オプション追加

```bash
pdf2anki convert input.pdf --cache          # キャッシュ有効
pdf2anki convert input.pdf --no-cache       # キャッシュ無効
pdf2anki convert input.pdf --cache-clear    # キャッシュクリア
```

### 検証方法

```bash
# 1. 初回実行 (キャッシュなし)
time uv run pdf2anki preview sample.pdf --cache
# → .cache/ にファイル生成を確認

# 2. 再実行 (キャッシュヒット)
time uv run pdf2anki preview sample.pdf --cache
# → 実行時間が大幅短縮を確認

# 3. テスト
uv run pytest tests/test_cache.py tests/test_extract.py -v --cov
```

---

## Task 2: Image-Aware Card Generation (P0, 8h)

### 目的

PDF 内の画像 (図表、チャート、数式) を検出・抽出し、Claude Vision API を使って画像付きカードを生成する。

### アーキテクチャ

```
PDF ページ
    ↓
[画像検出] pymupdf page.get_images()
    ↓
画像カバレッジ計算 (面積比 >= 20%)
    ↓ (画像あり)                    ↓ (テキストのみ)
[画像抽出] PNG 150 DPI           既存テキストパイプライン
    ↓
[Vision API] 画像 + テキスト同時送信
    ↓
画像対応カード生成:
  - QA (図の説明)
  - IMAGE_OCCLUSION (部分隠し)
  - COMPARE_CONTRAST (図の比較)
    ↓
[品質保証] 既存パイプライン
    ↓
[出力] TSV + 画像ファイル / JSON + base64
```

### ファイル構成

| ファイル | 操作 | LOC目安 | 内容 |
|---------|------|---------|------|
| `src/pdf2anki/image.py` | **新規** | ~250 | 画像検出・抽出・前処理 |
| `src/pdf2anki/vision.py` | **新規** | ~200 | Vision API 統合、画像付きプロンプト |
| `src/pdf2anki/schemas.py` | 修正 | +20 | AnkiCard に `media` フィールド追加 |
| `src/pdf2anki/extract.py` | 修正 | +30 | ExtractedDocument に `images` フィールド追加 |
| `src/pdf2anki/prompts.py` | 修正 | +40 | Vision 用プロンプト追加 |
| `src/pdf2anki/structure.py` | 修正 | +50 | 画像付きメッセージ構築 |
| `src/pdf2anki/cost.py` | 修正 | +10 | Vision トークン計算追加 |
| `src/pdf2anki/convert.py` | 修正 | +30 | TSV に画像参照、JSON に base64 |
| `src/pdf2anki/service.py` | 修正 | +20 | 画像抽出の統合 |
| `src/pdf2anki/config.py` | 修正 | +10 | `vision` セクション追加 |
| `config.yaml` | 修正 | +5 | Vision 設定 |
| `tests/test_image.py` | **新規** | ~200 | 画像検出・抽出テスト |
| `tests/test_vision.py` | **新規** | ~200 | Vision API テスト |
| `tests/fixtures/sample_with_images.pdf` | **新規** | - | テスト用画像入り PDF |

### image.py 設計

```python
# src/pdf2anki/image.py (~250 LOC)

@dataclass(frozen=True, slots=True)
class ExtractedImage:
    """PDF から抽出された画像。"""
    page_num: int
    index: int
    width: int
    height: int
    bbox: tuple[float, float, float, float]  # (x0, y0, x1, y1)
    image_bytes: bytes
    media_type: str  # "image/png" | "image/jpeg"
    coverage: float  # ページ内のカバレッジ率

@dataclass(frozen=True, slots=True)
class PageImageInfo:
    """ページの画像分析結果。"""
    page_num: int
    has_significant_images: bool
    coverage: float
    images: tuple[ExtractedImage, ...]

# Claude Vision API の制限
VISION_MAX_DIMENSION = 1568       # px (長辺)
VISION_MAX_MEGAPIXELS = 1.15      # MP
VISION_RECOMMENDED_DPI = 150

def detect_page_images(page: pymupdf.Page) -> PageImageInfo:
    """ページ内の画像を検出し、カバレッジを計算。"""

def extract_image(
    doc: pymupdf.Document,
    page: pymupdf.Page,
    xref: int,
    *,
    max_dimension: int = VISION_MAX_DIMENSION,
) -> ExtractedImage:
    """単一画像を抽出し、Vision API 制限にリサイズ。"""

def extract_page_images(
    doc: pymupdf.Document,
    *,
    coverage_threshold: float = 0.20,
) -> list[PageImageInfo]:
    """全ページの画像を分析・抽出。閾値未満のページはスキップ。"""

def image_to_base64(image: ExtractedImage) -> str:
    """画像を base64 エンコード (Vision API 用)。"""
```

### vision.py 設計

```python
# src/pdf2anki/vision.py (~200 LOC)

VISION_SYSTEM_PROMPT = """\
You are an expert Anki flashcard generator with vision capabilities.
Analyze the provided image alongside the text to create cards that:
1. Describe diagrams, charts, and visual elements
2. Create image occlusion cards (label hidden parts)
3. Connect visual content to textual explanations
...
"""

def build_vision_messages(
    text: str,
    images: list[ExtractedImage],
    *,
    max_cards: int = 20,
    card_types: list[str] | None = None,
) -> list[MessageParam]:
    """画像 + テキストの複合メッセージを構築。

    Claude API format:
    [
        {"type": "image", "source": {"type": "base64", ...}},
        {"type": "image", "source": {"type": "base64", ...}},
        {"type": "text", "text": "Generate cards from..."}
    ]
    """

def extract_cards_with_vision(
    text: str,
    images: list[ExtractedImage],
    *,
    source_file: str,
    config: AppConfig,
    cost_tracker: CostTracker,
) -> tuple[ExtractionResult, CostTracker]:
    """Vision API でカード生成。画像なしの場合は通常パスにフォールバック。"""
```

### schemas.py 変更

```python
class AnkiCard(BaseModel, frozen=True):
    front: str = Field(min_length=1)
    back: str = Field(default="")
    card_type: CardType
    bloom_level: BloomLevel
    tags: list[str] = Field(min_length=1)
    related_concepts: list[str] = Field(default_factory=list)
    mnemonic_hint: str | None = Field(default=None)
    media: list[str] = Field(default_factory=list)  # 新規: 画像ファイル名リスト
```

### extract.py 変更

```python
@dataclass(frozen=True, slots=True)
class ExtractedDocument:
    source_path: str
    text: str
    chunks: tuple[str, ...]
    file_type: str
    used_ocr: bool
    sections: tuple[Section, ...] = ()
    images: tuple[ExtractedImage, ...] = ()  # 新規: 抽出された画像
```

### cost.py Vision トークン計算

```python
# Claude Vision API: 画像トークン = (width * height) / 750
# 参考: 1092x1092 = 約 1,590 トークン

def estimate_image_tokens(width: int, height: int) -> int:
    """画像の入力トークン数を推定。"""
    return (width * height) // 750
```

### convert.py 画像出力

**TSV 形式:**
- Anki のメディア参照形式: `<img src="image_name.png">`
- front/back フィールドに HTML `<img>` タグ埋め込み

**JSON 形式:**
- `media` フィールドに画像ファイル名
- 別途 `_media/` ディレクトリに画像ファイル出力

### config.yaml 追加

```yaml
vision:
  enabled: true
  coverage_threshold: 0.20  # 20% 以上で画像ページと判定
  dpi: 150
  max_images_per_page: 5    # 1ページあたりの最大画像数
```

### CLI オプション追加

```bash
pdf2anki convert input.pdf --vision          # Vision 有効 (デフォルト: 画像検出時自動)
pdf2anki convert input.pdf --no-vision       # Vision 無効 (テキストのみ)
```

### 実装サブステップ

| # | タスク | 工数 | TDD |
|---|--------|------|-----|
| 2.1 | `image.py` + `test_image.py` (画像検出・抽出) | 2h | RED→GREEN |
| 2.2 | `schemas.py` + `extract.py` 修正 (media/images フィールド) | 0.5h | テスト更新 |
| 2.3 | `vision.py` + `test_vision.py` (Vision API 統合) | 2h | RED→GREEN |
| 2.4 | `prompts.py` + `structure.py` 修正 (Vision プロンプト) | 1h | テスト更新 |
| 2.5 | `cost.py` + `convert.py` 修正 (トークン計算・出力) | 1h | テスト更新 |
| 2.6 | `service.py` + `config.py` + `main.py` 統合 | 1h | E2E テスト |
| 2.7 | テスト用 PDF 作成 + 統合テスト | 0.5h | GREEN確認 |

### 検証方法

```bash
# 1. 画像検出テスト
uv run pytest tests/test_image.py -v

# 2. Vision API テスト (モック)
uv run pytest tests/test_vision.py -v

# 3. E2E テスト (実 API、画像入り PDF)
ANTHROPIC_API_KEY=... uv run pdf2anki convert tests/fixtures/sample_with_images.pdf \
  --vision --format both -o output/

# 4. カバレッジ確認
uv run pytest --cov=src/pdf2anki --cov-report=term-missing
```

### 技術的注意点

1. **Claude Vision 制限**: 長辺 1568px、推奨 ~1.15MP。`image.py` でリサイズ必須
2. **コスト**: 画像トークン = (w*h)/750。1092x1092 の画像 ≈ 1,590 tokens ≈ $0.005 (Sonnet)
3. **Prompt Caching**: 画像を含むメッセージでは `cache_control` の配置に注意
4. **対応フォーマット**: image/jpeg, image/png, image/gif, image/webp
5. **Batch API**: 現時点では Vision + Batch の組み合わせは未確認。初期は同期 API のみ

---

## Task 3: Prompt Evaluation Framework (P1, 4h)

### 目的

プロンプト変更の影響を定量的に測定し、回帰を防止する仕組みを構築する。

### アーキテクチャ

```
評価データセット (YAML)
    ↓
[Dataset Loader] → EvalCase リスト
    ↓
[Card Generator] → 生成カード (既存パイプライン利用)
    ↓
[Card Matcher] → 期待カードとのマッチング
    ↓
[Metrics Calculator] → Recall, Precision, F1, Quality, Cost
    ↓
[Report Generator] → Rich テーブル出力 / JSON レポート
```

### ファイル構成

| ファイル | 操作 | LOC目安 | 内容 |
|---------|------|---------|------|
| `src/pdf2anki/eval/__init__.py` | **新規** | ~10 | パッケージ re-export |
| `src/pdf2anki/eval/dataset.py` | **新規** | ~120 | データセットスキーマ・ローダー |
| `src/pdf2anki/eval/matcher.py` | **新規** | ~150 | カードマッチングロジック |
| `src/pdf2anki/eval/metrics.py` | **新規** | ~100 | メトリクス計算 |
| `src/pdf2anki/eval/report.py` | **新規** | ~120 | レポート生成 |
| `src/pdf2anki/main.py` | 修正 | +30 | `eval` サブコマンド追加 |
| `evals/dataset.yaml` | **新規** | ~100 | 初期評価データセット |
| `tests/test_eval.py` | **新規** | ~250 | Eval テスト |

### eval/dataset.py 設計

```python
# src/pdf2anki/eval/dataset.py (~120 LOC)

@dataclass(frozen=True)
class ExpectedCard:
    """期待されるカード (部分一致で評価)。"""
    front_keywords: list[str]    # front に含まれるべきキーワード
    back_keywords: list[str]     # back に含まれるべきキーワード
    card_type: CardType | None = None  # 期待されるカードタイプ
    tags: list[str] = ()         # 期待されるタグ (部分一致)

@dataclass(frozen=True)
class EvalCase:
    """単一の評価ケース。"""
    id: str
    text: str                      # 入力テキスト
    expected_cards: tuple[ExpectedCard, ...]
    description: str = ""

@dataclass(frozen=True)
class EvalDataset:
    """評価データセット。"""
    name: str
    version: str
    cases: tuple[EvalCase, ...]

def load_dataset(path: Path) -> EvalDataset:
    """YAML ファイルからデータセットを読み込み。"""
```

### eval/matcher.py 設計

```python
# src/pdf2anki/eval/matcher.py (~150 LOC)

@dataclass(frozen=True)
class MatchResult:
    """単一カードのマッチング結果。"""
    expected: ExpectedCard
    matched_card: AnkiCard | None  # マッチしたカード (None = 未生成)
    similarity: float              # 0.0-1.0

@dataclass(frozen=True)
class CaseResult:
    """単一ケースの評価結果。"""
    case_id: str
    generated_cards: tuple[AnkiCard, ...]
    matches: tuple[MatchResult, ...]
    unmatched_generated: tuple[AnkiCard, ...]  # 期待にないカード

def match_cards(
    expected: list[ExpectedCard],
    generated: list[AnkiCard],
    *,
    threshold: float = 0.5,
) -> CaseResult:
    """期待カードと生成カードをキーワードベースでマッチング。

    マッチング戦略:
    1. front_keywords の Jaccard 類似度
    2. back_keywords の Jaccard 類似度
    3. card_type の一致ボーナス
    4. 重み付き合計 >= threshold でマッチ
    """
```

### eval/metrics.py 設計

```python
# src/pdf2anki/eval/metrics.py (~100 LOC)

@dataclass(frozen=True)
class EvalMetrics:
    """評価メトリクス。"""
    recall: float       # 期待カードのうち生成された割合
    precision: float    # 生成カードのうち正しい割合
    f1: float          # 調和平均
    avg_quality: float  # 平均品質スコア
    duplicate_rate: float
    total_cost_usd: float
    total_expected: int
    total_generated: int
    total_matched: int

def calculate_metrics(
    case_results: list[CaseResult],
    quality_scores: list[float] | None = None,
    cost_usd: float = 0.0,
) -> EvalMetrics:
    """全ケースの結果からメトリクスを計算。"""
```

### eval/report.py 設計

```python
# src/pdf2anki/eval/report.py (~120 LOC)

def print_eval_report(metrics: EvalMetrics, case_results: list[CaseResult]) -> None:
    """Rich テーブルで評価レポートを表示。"""

def print_comparison_report(
    metrics_a: EvalMetrics,
    metrics_b: EvalMetrics,
    label_a: str = "v1",
    label_b: str = "v2",
) -> None:
    """2つのメトリクスの比較レポートを表示。"""

def write_eval_json(
    metrics: EvalMetrics,
    case_results: list[CaseResult],
    output_path: Path,
) -> None:
    """JSON 形式で評価結果を保存。"""
```

### evals/dataset.yaml 初期データ

```yaml
name: "pdf2anki-core"
version: "1.0"
cases:
  - id: "buddhism-01"
    description: "仏教の基本概念"
    text: |
      四諦とは、仏教の根本教義であり、苦諦・集諦・滅諦・道諦の
      4つの真理を指す。釈迦が初転法輪で説いたとされる。
    expected_cards:
      - front_keywords: ["四諦", "何"]
        back_keywords: ["苦諦", "集諦", "滅諦", "道諦"]
        card_type: qa
      - front_keywords: ["四諦", "4つ"]
        back_keywords: ["苦諦", "集諦", "滅諦", "道諦"]
        card_type: cloze

  - id: "ml-01"
    description: "機械学習の基本分類"
    text: |
      機械学習は大きく3つに分類される：教師あり学習、教師なし学習、
      強化学習である。教師あり学習はラベル付きデータを使用し、
      教師なし学習はラベルなしデータからパターンを発見する。
    expected_cards:
      - front_keywords: ["機械学習", "分類"]
        back_keywords: ["教師あり", "教師なし", "強化"]
        card_type: cloze
      - front_keywords: ["教師あり学習"]
        back_keywords: ["ラベル"]

  # ... 10-20 ケースを初期データセットとして用意
```

### CLI サブコマンド

```bash
# 単一プロンプトの評価
pdf2anki eval --dataset evals/dataset.yaml

# 2つのプロンプトバージョンを比較
pdf2anki eval --dataset evals/dataset.yaml --compare prompts/v1.txt prompts/v2.txt

# JSON レポート出力
pdf2anki eval --dataset evals/dataset.yaml --output eval-report.json
```

### 実装サブステップ

| # | タスク | 工数 | TDD |
|---|--------|------|-----|
| 3.1 | `eval/dataset.py` + テスト (スキーマ・ローダー) | 1h | RED→GREEN |
| 3.2 | `eval/matcher.py` + テスト (マッチングロジック) | 1h | RED→GREEN |
| 3.3 | `eval/metrics.py` + テスト (メトリクス計算) | 0.5h | RED→GREEN |
| 3.4 | `eval/report.py` + テスト (レポート生成) | 0.5h | RED→GREEN |
| 3.5 | `main.py` に `eval` サブコマンド追加 | 0.5h | E2E テスト |
| 3.6 | `evals/dataset.yaml` 初期データセット作成 | 0.5h | - |

### 検証方法

```bash
# 1. ユニットテスト
uv run pytest tests/test_eval.py -v

# 2. 実行テスト
uv run pdf2anki eval --dataset evals/dataset.yaml

# 3. カバレッジ
uv run pytest --cov=src/pdf2anki --cov-report=term-missing
```

---

## Task 4: Interactive Review TUI (P1, 6h)

### 目的

生成されたカードを Anki インポート前に対話的にレビュー・編集できる TUI を提供する。

### 技術選定

**Textual** (Python TUI フレームワーク)
- Rich との親和性 (既に rich を使用中)
- App / Screen / Widget の階層構造
- DataTable, Header, Footer 等の標準ウィジェット
- キーバインディングシステム
- CSS によるスタイリング

### 画面設計

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ pdf2anki Review: input.pdf                       ┃  ← Header
┠─────────────────────────────────────────────────━┨
┃                                                   ┃
┃  Card 3/47              Quality: 8.5/10  [QA]    ┃  ← カード情報
┃  ┌───────────────────────────────────────────┐   ┃
┃  │ Front: ニューラルネットワークの活性化       │   ┃  ← カード表示
┃  │        関数の役割は何ですか？               │   ┃
┃  ├───────────────────────────────────────────┤   ┃
┃  │ Back:  非線形変換を導入し、複雑なパターン   │   ┃
┃  │        の学習を可能にする。                 │   ┃
┃  ├───────────────────────────────────────────┤   ┃
┃  │ Tags:  AI::基礎, neural_network           │   ┃
┃  │ Bloom: understand                         │   ┃
┃  └───────────────────────────────────────────┘   ┃
┃                                                   ┃
┃  [A]ccept  [R]eject  [E]dit  [N]ext  [P]rev     ┃  ← アクション
┃                                                   ┃
┠───────────────────────────────────────────────────┨
┃ Stats: 47 total | 12 accepted | 3 rejected | 32  ┃  ← ステータスバー
┃        pending  | Avg: 8.2/10                     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

### ファイル構成

| ファイル | 操作 | LOC目安 | 内容 |
|---------|------|---------|------|
| `src/pdf2anki/tui/__init__.py` | **新規** | ~10 | パッケージ |
| `src/pdf2anki/tui/app.py` | **新規** | ~200 | Textual App メインクラス |
| `src/pdf2anki/tui/screens.py` | **新規** | ~150 | ReviewScreen, EditScreen |
| `src/pdf2anki/tui/widgets.py` | **新規** | ~150 | CardDisplay, StatsBar |
| `src/pdf2anki/tui/state.py` | **新規** | ~100 | ReviewState (不変) |
| `src/pdf2anki/main.py` | 修正 | +20 | `--review` フラグ追加 |
| `tests/test_tui.py` | **新規** | ~200 | TUI テスト (Textual pilot) |

### tui/state.py 設計

```python
# src/pdf2anki/tui/state.py (~100 LOC)

class CardStatus(StrEnum):
    PENDING = "pending"
    ACCEPTED = "accepted"
    REJECTED = "rejected"

@dataclass(frozen=True)
class ReviewCard:
    """レビュー対象のカード (状態付き)。"""
    card: AnkiCard
    quality_score: float
    status: CardStatus = CardStatus.PENDING

@dataclass(frozen=True)
class ReviewState:
    """レビューセッションの状態。不変。"""
    cards: tuple[ReviewCard, ...]
    current_index: int = 0
    source_file: str = ""

    @property
    def current_card(self) -> ReviewCard: ...
    @property
    def total(self) -> int: ...
    @property
    def accepted_count(self) -> int: ...
    @property
    def rejected_count(self) -> int: ...
    @property
    def pending_count(self) -> int: ...
    @property
    def avg_quality(self) -> float: ...

    def accept_current(self) -> ReviewState: ...
    def reject_current(self) -> ReviewState: ...
    def move_next(self) -> ReviewState: ...
    def move_prev(self) -> ReviewState: ...
    def update_card(self, index: int, card: AnkiCard) -> ReviewState: ...
```

### tui/app.py 設計

```python
# src/pdf2anki/tui/app.py (~200 LOC)

class ReviewApp(App):
    """カードレビュー TUI アプリケーション。"""

    BINDINGS = [
        Binding("a", "accept", "Accept"),
        Binding("r", "reject", "Reject"),
        Binding("e", "edit", "Edit"),
        Binding("n", "next", "Next"),
        Binding("p", "prev", "Prev"),
        Binding("f", "filter", "Filter"),
        Binding("s", "save", "Save"),
        Binding("q", "quit", "Quit"),
    ]

    def __init__(self, state: ReviewState, output_path: Path, fmt: str):
        super().__init__()
        self.state = state
        self.output_path = output_path
        self.fmt = fmt

    def compose(self) -> ComposeResult:
        yield Header()
        yield CardDisplay()
        yield StatsBar()
        yield Footer()

    def action_accept(self) -> None:
        self.state = self.state.accept_current().move_next()
        self._refresh_display()

    def action_save(self) -> None:
        """承認済みカードのみ出力。"""
        accepted_cards = [rc.card for rc in self.state.cards
                          if rc.status == CardStatus.ACCEPTED]
        # write_output() 呼び出し
```

### Textual CSS

```css
/* src/pdf2anki/tui/review.tcss */
CardDisplay {
    height: auto;
    margin: 1 2;
    border: solid green;
}

StatsBar {
    dock: bottom;
    height: 3;
    background: $surface;
}
```

### CLI 統合

```bash
# レビューモードで実行
pdf2anki convert input.pdf --review

# レビューモード + 品質フィルタ
pdf2anki convert input.pdf --review --quality full
```

### 実装サブステップ

| # | タスク | 工数 | TDD |
|---|--------|------|-----|
| 4.1 | `tui/state.py` + テスト (不変状態管理) | 1h | RED→GREEN |
| 4.2 | `tui/widgets.py` (CardDisplay, StatsBar) | 1.5h | Textual pilot |
| 4.3 | `tui/screens.py` (ReviewScreen, EditScreen) | 1.5h | Textual pilot |
| 4.4 | `tui/app.py` (メイン App + キーバインド) | 1h | 統合テスト |
| 4.5 | `main.py` 統合 + E2E テスト | 1h | E2E |

### 検証方法

```bash
# 1. 状態管理テスト
uv run pytest tests/test_tui.py -v

# 2. 手動テスト
uv run pdf2anki convert tests/fixtures/sample.txt --review

# 3. Textual dev ツール (デバッグ)
uv run textual run --dev src/pdf2anki/tui/app.py
```

---

## Task 5: LinkedIn/GitHub プロフィール英語化 (P2, 2h)

### 内容

Phase 1 から移動されたコード外タスク。

- [ ] GitHub プロフィール README.md を英語化
- [ ] LinkedIn のヘッドライン・概要を英語に更新
- [ ] pdf2anki の README.md 英語版を更新
- [ ] GitHub リポジトリの Description を英語に

### 備考

このタスクはコード変更を伴わない。他のコードタスクの合間に実施。

---

## Task 6: Zenn 記事 3 本公開 (P2, 4h)

### 記事タイトル案

1. **「pdf2anki への画像抽出機能追加: Vision API の活用と実装の詳細」** (Task 2 完了後)
   - 技術選定 (Vision API vs OCR)
   - pymupdf での画像検出・抽出
   - Claude Vision API の実践的な使い方
   - コスト最適化 (DPI、リサイズ、トークン数)

2. **「CLI ツールに TUI を追加する: Textual でインタラクティブなレビュー体験を実現」** (Task 4 完了後)
   - Textual の選定理由
   - 不変状態管理パターン
   - Textual の CSS スタイリング
   - ユーザビリティ向上のポイント

3. **「LLM プロンプトの品質を測る: Eval Framework の設計と実装」** (Task 3 完了後)
   - プロンプト評価の重要性
   - キーワードベースのカードマッチング
   - Recall / Precision / F1 の解釈
   - CI 統合のヒント

### 執筆フロー

```
SpecStory セッションログ → 記事骨子自動生成 → editor エージェントレビュー → 公開
```

---

## 依存パッケージ追加

```bash
# Phase 2 で追加する依存
uv add textual       # TUI フレームワーク (Task 4)
# pymupdf は既存 (Task 2 の画像抽出に使用)
# anthropic は既存 (Task 2 の Vision API に使用)
```

### pyproject.toml 変更

```toml
[project]
dependencies = [
    # ... 既存 ...
    "textual>=1.0.0",   # TUI (Phase 2)
]
```

---

## リスクと軽減策

| リスク | 影響度 | 軽減策 |
|--------|--------|--------|
| Vision API の画像トークンコストが想定超過 | 中 | DPI 150、最大 5 画像/ページ制限、budget_limit 適用 |
| 複雑な PDF (手書き図、縦書き) で Vision 精度低下 | 中 | coverage_threshold で画像ページを限定、テキスト抽出にフォールバック |
| Textual の学習コスト | 低 | 最小限のウィジェット、Textual pilot テスト活用 |
| Eval のカードマッチング精度 | 中 | キーワードベース (シンプル) から開始、将来セマンティック類似度に拡張 |
| schemas.py の `media` フィールド追加による後方互換 | 低 | デフォルト空リスト、既存テスト影響なし |

---

## 成功指標

- [ ] Vision API で画像を含むカードが生成できる
- [ ] TUI でカードを対話的にレビューできる
- [ ] プロンプト評価フレームワークが動作する
- [ ] テキスト抽出がキャッシュで高速化されている
- [ ] Zenn に 3 本の技術記事が公開されている
- [ ] テストカバレッジ 80% 以上を維持
- [ ] ローカルフォルダ名を `Anki-QA` → `pdf2anki` にリネーム + Claude Code メモリ移行
- [ ] v0.3.0 リリース

---

## 全体検証

```bash
cd /Users/shimomoto_tatsuya/MyAI_Lab/Anki-QA

# 依存インストール
uv sync --all-extras

# 全テスト実行
uv run pytest tests/ -v --cov=src/pdf2anki --cov-report=term-missing

# カバレッジ 80% 以上を確認
# fail_under = 80 (pyproject.toml)

# E2E: キャッシュ + Vision + レビュー
uv run pdf2anki convert tests/fixtures/sample_with_images.pdf \
  --cache --vision --review --quality full --format both -o output/

# Eval 実行
uv run pdf2anki eval --dataset evals/dataset.yaml
```

---

## 参考資料

- [Claude Vision API](https://docs.claude.com/en/build-with-claude/vision) - 画像入力仕様
- [Textual](https://textual.textualize.io/) - Python TUI フレームワーク
- [pymupdf Image Recipes](https://pymupdf.readthedocs.io/en/latest/recipes-images.html) - 画像抽出
- `docs/research/image-extraction-examples.py` - 画像抽出研究コード
- `docs/plans/next-features-handoff.md` - Phase 2 事前調査
- `docs/plans/2026-02-08_PLAN_pdf2anki.md` - Phase 1 実装計画
